<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam 1 Practice Test (Answer Key)</title>
    <link rel="stylesheet" href="css/quiz.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Exam 1 Practice Test (Answer Key)</h1>
            <div class="progress" id="progress">Loading...</div>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            Loading quiz questions...
        </div>

        <form id="quiz-form" style="display: none;">
            <div id="definitions-container"></div>
            <div id="questions-container"></div>
            <button type="button" class="submit-button" onclick="checkAnswers()">Submit Quiz</button>
        </form>

        <div id="results" class="results" style="display:none;">
            <h2>Quiz Results</h2>
            <div id="score" class="score"></div>
        </div>

        <a href="index.html" class="back-link">‚Üê Back to Home</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        let quizData = null;

        // Load quiz data from YAML file
        async function loadQuizData() {
            try {
                const response = await fetch('data/exam1-practice-key.yml');
                const yamlText = await response.text();
                quizData = jsyaml.load(yamlText);

                renderQuiz();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('quiz-form').style.display = 'block';

            } catch (error) {
                console.error('Error loading quiz data:', error);
                // Show error message if loading fails
                document.getElementById('loading').innerHTML = 'Error loading quiz data. Please refresh the page.';
            }
        }

        function renderQuiz() {
            if (!quizData) return;

            // Render definitions if they exist
            if (quizData.definitions) {
                renderDefinitions();
            }

            // Render multiple choice questions if they exist
            if (quizData.questions) {
                renderQuestions();
            }

            // Update progress counter
            const totalItems = (quizData.definitions?.length || 0) + (quizData.questions?.length || 0);
            document.getElementById('progress').textContent = `${totalItems} Items`;
        }

        function renderDefinitions() {
            const container = document.getElementById('definitions-container');
            const definitions = quizData.definitions;

            // Add section header
            const headerDiv = document.createElement('div');
            headerDiv.innerHTML = '<h2 class="section-header">Part I: Definitions</h2><p class="section-description">Drag the correct words from the word bank to complete each definition.</p>';
            container.appendChild(headerDiv);

            definitions.forEach((definition, index) => {
                const defDiv = document.createElement('div');
                defDiv.className = 'definition-question';

                // Create sentence with dropzones
                const sentenceWithBlanks = definition.sentence.replace(/____/g, (match, offset) => {
                    const blankIndex = (definition.sentence.slice(0, offset).match(/____/g) || []).length;
                    return `<span class="drop-zone" data-def-id="${index}" data-blank-index="${blankIndex}">___</span>`;
                });

                // Shuffle word bank
                const shuffledWords = [...definition.word_bank].sort(() => Math.random() - 0.5);

                defDiv.innerHTML = `
                    <div class="definition-header">
                        <h3>${index + 1}. ${definition.term}</h3>
                        <span class="points">(${definition.points} points)</span>
                    </div>
                    <p class="definition-sentence">${sentenceWithBlanks}</p>
                    <div class="word-bank">
                        <div class="word-bank-label">Word Bank:</div>
                        <div class="word-bank-items">
                            ${shuffledWords.map(word => `
                                <span class="draggable-word" draggable="true" data-word="${word}">${word}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(defDiv);
            });

            // Add drag and drop event listeners
            setupDragAndDrop();
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            const questions = quizData.questions;

            // Add section header if definitions exist
            if (quizData.definitions) {
                const headerDiv = document.createElement('div');
                headerDiv.innerHTML = '<h2 class="section-header">Part II: Multiple Choice</h2><p class="section-description">Select the best answer for each question.</p>';
                container.appendChild(headerDiv);
            }

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <div class="question-header">
                        <h3>Question ${index + 1}</h3>
                        <span class="points">(${question.points} points)</span>
                    </div>
                    <p class="question-text">${question.question}</p>
                    <div class="options">
                        ${Object.entries(question.options).map(([key, value]) => `
                            <label class="option">
                                <input type="radio" name="q${index}" value="${key}" />
                                <span class="option-text">${key}) ${value}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }

        function setupDragAndDrop() {
            // Make words draggable
            document.querySelectorAll('.draggable-word').forEach(word => {
                word.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.word);
                    this.classList.add('dragging');
                });

                word.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                });
            });

            // Make drop zones accept drops
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });

                zone.addEventListener('dragleave', function(e) {
                    this.classList.remove('drag-over');
                });

                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');

                    const word = e.dataTransfer.getData('text/plain');

                    // If zone already has a word, return it to word bank
                    if (this.dataset.word) {
                        returnWordToBank(this.dataset.word);
                    }

                    // Place new word in zone
                    this.textContent = word;
                    this.dataset.word = word;
                    this.classList.add('filled');

                    // Remove word from word bank
                    const wordElement = document.querySelector(`.draggable-word[data-word="${word}"]`);
                    if (wordElement) {
                        wordElement.style.display = 'none';
                    }
                });

                // Allow clicking to remove words
                zone.addEventListener('click', function() {
                    if (this.dataset.word) {
                        returnWordToBank(this.dataset.word);
                        this.textContent = '___';
                        this.classList.remove('filled');
                        delete this.dataset.word;
                    }
                });
            });
        }

        function returnWordToBank(word) {
            const wordElement = document.querySelector(`.draggable-word[data-word="${word}"]`);
            if (wordElement) {
                wordElement.style.display = 'inline-block';
            }
        }

        function checkAnswers() {
            if (!quizData) return;

            let score = 0;
            let totalPoints = 0;
            let definitionResults = '';
            let questionResults = '';

            // Check definitions if they exist
            if (quizData.definitions) {
                const defResults = checkDefinitions();
                score += defResults.score;
                totalPoints += defResults.totalPoints;
                definitionResults = defResults.summary;
            }

            // Check multiple choice questions if they exist
            if (quizData.questions) {
                const mcResults = checkMultipleChoice();
                score += mcResults.score;
                totalPoints += mcResults.totalPoints;
                questionResults = mcResults.summary;
            }

            const percentage = totalPoints > 0 ? Math.round((score / totalPoints) * 100) : 0;

            document.getElementById('score').innerHTML = `
                <p><strong>Total Score: ${score}/${totalPoints} points (${percentage}%)</strong></p>
                ${definitionResults}
                ${questionResults}
            `;

            document.getElementById('results').style.display = 'block';
            document.getElementById('quiz-form').querySelector('.submit-button').style.display = 'none';

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function checkDefinitions() {
            let score = 0;
            let totalPoints = 0;
            let correct = 0;

            quizData.definitions.forEach((definition, index) => {
                totalPoints += definition.points;
                const dropZones = document.querySelectorAll(`[data-def-id="${index}"]`);
                let defCorrect = true;

                dropZones.forEach((zone, blankIndex) => {
                    const userWord = zone.dataset.word;
                    const correctWord = definition.blanks[blankIndex];

                    if (userWord === correctWord) {
                        zone.classList.add('correct-drop');
                    } else {
                        zone.classList.add('incorrect-drop');
                        if (userWord) {
                            // Show correct answer
                            zone.innerHTML = `<span class="user-answer">${userWord}</span> <span class="correct-answer-text">(${correctWord})</span>`;
                        } else {
                            zone.innerHTML = `<span class="correct-answer-text">${correctWord}</span>`;
                        }
                        defCorrect = false;
                    }
                });

                if (defCorrect && dropZones.length === definition.blanks.length) {
                    score += definition.points;
                    correct++;
                }
            });

            return {
                score: score,
                totalPoints: totalPoints,
                summary: `<p>Definitions: ${correct}/${quizData.definitions.length} correct</p>`
            };
        }

        function checkMultipleChoice() {
            let score = 0;
            let totalPoints = 0;
            let correct = 0;

            quizData.questions.forEach((question, index) => {
                totalPoints += question.points;
                const selectedAnswer = document.querySelector(`input[name="q${index}"]:checked`);
                const questionDiv = document.querySelectorAll('.question')[index];
                const options = questionDiv.querySelectorAll('.option');

                // Reset previous styling
                options.forEach(option => {
                    option.classList.remove('correct', 'incorrect', 'correct-answer');
                });

                if (selectedAnswer) {
                    const selectedValue = selectedAnswer.value;
                    const correctAnswer = question.correct_answer;

                    if (selectedValue === correctAnswer) {
                        score += question.points;
                        correct++;
                        // Mark selected answer as correct
                        selectedAnswer.closest('.option').classList.add('correct');
                    } else {
                        // Mark selected answer as incorrect
                        selectedAnswer.closest('.option').classList.add('incorrect');
                        // Show correct answer
                        options.forEach(option => {
                            const input = option.querySelector('input');
                            if (input.value === correctAnswer) {
                                option.classList.add('correct-answer');
                            }
                        });
                    }
                } else {
                    // No answer selected - show correct answer
                    options.forEach(option => {
                        const input = option.querySelector('input');
                        if (input.value === question.correct_answer) {
                            option.classList.add('correct-answer');
                        }
                    });
                }
            });

            return {
                score: score,
                totalPoints: totalPoints,
                summary: `<p>Multiple Choice: ${correct}/${quizData.questions.length} correct</p>`
            };
        }

        // Load quiz when page loads
        window.addEventListener('load', loadQuizData);
    </script>
</body>
</html>