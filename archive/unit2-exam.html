<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Practice Test</title>
    <link rel="stylesheet" href="css/quiz.css">
    <link rel="stylesheet" href="css/exam-print.css" media="print">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="home-link">← Home</a>
            <div class="header-center">
                <h1 id="quiz-title">Practice Test</h1>
                <div class="progress" id="progress">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            Loading quiz questions...
        </div>

        <!-- Print-only cover page -->
        <div id="exam-cover-page" class="exam-cover-page">
            <div class="cover-header">
                <h1 id="cover-title">Practice Exam</h1>
                <div class="cover-info">
                    <div class="name-field">
                        <label>Name: _____________________________________________</label>
                    </div>
                    <div class="date-field">
                        <label>Date: _____________________________________________</label>
                    </div>
                </div>
            </div>

            <!-- Scantron-style bubble sheet -->
            <div class="scantron-section">
                <h2>Part I: Multiple Choice</h2>
                <p class="scantron-instructions">Fill in the bubble corresponding to your answer choice.</p>
                <div id="scantron-grid" class="scantron-grid">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <form id="quiz-form" style="display: none;">
            <div id="questions-container"></div>
            <div id="true-make-true-container"></div>
            <div id="table-container"></div>
            <div id="essay-container"></div>
            <button type="button" class="submit-button" onclick="checkAnswers()">Submit Quiz</button>
        </form>

        <div id="results" class="results" style="display:none;">
            <h2>Quiz Results</h2>
            <div id="score" class="score"></div>
            <button type="button" id="calculate-final-score" class="submit-button" onclick="calculateFinalScore()" style="display: none; margin-top: 16px;">Calculate Final Score (with Essays)</button>
            <div id="final-score" class="score" style="display: none; margin-top: 16px;"></div>
        </div>

        <a href="index.html" class="back-link">← Back to Home</a>

        <!-- Print-only answer key -->
        <div id="answer-key" class="answer-key">
            <h1 class="answer-key-title">Answer Key</h1>
            <div id="answer-key-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        let quizData = null;
        let selectedQuestions = null;

        // Load quiz data from YAML file
        async function loadQuizData() {
            try {
                const response = await fetch('data/unit2-exam.yml');
                const yamlText = await response.text();
                quizData = jsyaml.load(yamlText);

                // Update page title and header
                if (quizData.title) {
                    document.getElementById('page-title').textContent = quizData.title;
                    document.getElementById('quiz-title').innerHTML = quizData.title;
                    document.getElementById('cover-title').innerHTML = quizData.title;
                }

                renderQuiz();
                renderScantron();
                renderAnswerKey();
                updateProgress();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('quiz-form').style.display = 'block';

            } catch (error) {
                console.error('Error loading quiz data:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #ef4444; text-align: center;">
                        <h3>Error Loading Quiz</h3>
                        <p>Could not load quiz data for Unit 2 Exam</p>
                        <p>Please check that the file exists at: data/unit2-exam.yml</p>
                        <a href="index.html" style="color: #3b82f6;">← Back to Home</a>
                    </div>
                `;
            }
        }

        function renderQuiz() {
            if (!quizData || !quizData.multipleChoice) return;

            const container = document.getElementById('questions-container');
            const allQuestions = quizData.multipleChoice;

            // Check if randomization is disabled (default is true for backwards compatibility)
            const shouldRandomize = quizData.randomize !== false;

            if (shouldRandomize) {
                // Get max questions limit (default to all if not specified)
                const maxQuestions = quizData.maxQuestions || allQuestions.length;

                // Separate questions by category
                const bloodQuestions = allQuestions.filter(q => q.tags && q.tags.includes('blood'));
                const heartQuestions = allQuestions.filter(q => q.tags && q.tags.includes('heart'));
                const vesselQuestions = allQuestions.filter(q => q.tags && q.tags.includes('vessels'));

                // Calculate proportional distribution based on available questions
                const totalAvailable = bloodQuestions.length + heartQuestions.length + vesselQuestions.length;
                const bloodCount = Math.round((bloodQuestions.length / totalAvailable) * maxQuestions);
                const heartCount = Math.round((heartQuestions.length / totalAvailable) * maxQuestions);
                const vesselCount = maxQuestions - bloodCount - heartCount; // Remainder goes to vessels

                // Randomly select from each category
                const shuffledBlood = [...bloodQuestions].sort(() => 0.5 - Math.random());
                const shuffledHeart = [...heartQuestions].sort(() => 0.5 - Math.random());
                const shuffledVessels = [...vesselQuestions].sort(() => 0.5 - Math.random());

                const selectedBlood = shuffledBlood.slice(0, Math.min(bloodCount, bloodQuestions.length));
                const selectedHeart = shuffledHeart.slice(0, Math.min(heartCount, heartQuestions.length));
                const selectedVessels = shuffledVessels.slice(0, Math.min(vesselCount, vesselQuestions.length));

                // Combine and shuffle the final selection
                selectedQuestions = [...selectedBlood, ...selectedHeart, ...selectedVessels].sort(() => 0.5 - Math.random());
            } else {
                // Use all questions in order (no randomization)
                selectedQuestions = allQuestions;
            }

            // Render multiple choice questions
            selectedQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';

                const imageHTML = question.image ? `<div class="question-image"><img src="images/${question.image}" alt="Question ${index + 1} diagram" /></div>` : '';

                questionCard.innerHTML = `
                    <div class="question-number">Question ${index + 1}</div>
                    ${imageHTML}
                    <div class="question-text">${question.question}</div>
                    <div class="options">
                        ${question.options.map((option, optionIndex) => `
                            <label class="option">
                                <input type="radio" name="q${index}" value="${optionIndex}">
                                <span class="option-text">${String.fromCharCode(97 + optionIndex)}) ${option}</span>
                            </label>
                        `).join('')}
                    </div>
                `;

                container.appendChild(questionCard);
            });

            // Render True/Make True section if it exists
            if (quizData.trueMakeTrue && quizData.trueMakeTrue.length > 0) {
                const tmtContainer = document.getElementById('true-make-true-container');
                tmtContainer.className = 'true-make-true-section';

                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'section-title';
                sectionTitle.textContent = 'Part II: True/Make True';
                tmtContainer.appendChild(sectionTitle);

                const instructions = document.createElement('div');
                instructions.className = 'tmt-instructions';
                instructions.style.textAlign = 'center';
                instructions.style.marginBottom = '20px';
                instructions.style.color = '#6b7280';
                instructions.style.fontSize = '0.9rem';
                instructions.innerHTML = 'If the statement is true, write "True". If false, write the word that makes it true. (2.5 pts each)';
                tmtContainer.appendChild(instructions);

                quizData.trueMakeTrue.forEach((item, index) => {
                    const tmtCard = document.createElement('div');
                    tmtCard.className = 'true-make-true-card';

                    // Process statement to highlight bold/italic words
                    let processedStatement = item.statement.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');

                    tmtCard.innerHTML = `
                        <div class="question-number">Statement ${index + 1} (${item.points || 1} points)</div>
                        <div class="statement-container">
                            <input type="text" class="answer-input" name="tmt${index}" placeholder="Your answer..." autocomplete="off" data-1p-ignore autocorrect="off" autocapitalize="none" spellcheck="false">
                            <div class="statement-text">${processedStatement}</div>
                        </div>
                        <div class="feedback-text" id="tmt-feedback-${index}" style="display: none;"></div>
                    `;

                    tmtContainer.appendChild(tmtCard);
                });
            }

            // Render Essay/Table section if either exists
            if ((quizData.essay && quizData.essay.length > 0) || (quizData.table && quizData.table.length > 0)) {
                const essayContainer = document.getElementById('essay-container');
                essayContainer.className = 'essay-section';

                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'section-title';
                let partNumber = 'II';
                if (quizData.trueMakeTrue && quizData.trueMakeTrue.length > 0) partNumber = 'III';
                sectionTitle.textContent = `Part ${partNumber}: Short/Long Answer`;
                essayContainer.appendChild(sectionTitle);

                const instructions = document.createElement('div');
                instructions.style.textAlign = 'center';
                instructions.style.marginBottom = '20px';
                instructions.style.color = '#6b7280';
                instructions.style.fontSize = '0.9rem';
                instructions.innerHTML = 'Please answer all of the following questions.';
                essayContainer.appendChild(instructions);

                let questionCounter = 1;

                // Render table questions first
                if (quizData.table && quizData.table.length > 0) {
                    quizData.table.forEach((item, index) => {
                        const tableCard = document.createElement('div');
                        tableCard.className = 'table-card';

                        const headers = item.headers || ['Column 1', 'Column 2'];
                        const numRows = item.answer ? item.answer.length : 3;

                        let tableHTML = `
                            <div class="question-number">Question ${questionCounter} (${item.points} points)</div>
                            <div class="table-question">${item.question}</div>
                            <div class="table-answer-container">
                                <table class="answer-table">
                                    <thead>
                                        <tr>
                                            ${headers.map(header => `<th>${header}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        for (let row = 0; row < numRows; row++) {
                            tableHTML += '<tr>';
                            headers.forEach((header, col) => {
                                tableHTML += `<td><input type="text" name="table${index}-${row}-${col}" autocomplete="off" autocorrect="off" spellcheck="false" onkeydown="handleTableNavigation(event, ${index}, ${row}, ${col}, ${numRows}, ${headers.length})" /></td>`;
                            });
                            tableHTML += '</tr>';
                        }

                        tableHTML += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-answer" id="table-answer-${index}" style="display: none;">
                                <h4>Sample Answer:</h4>
                                <table class="sample-answer-table">
                                    <thead>
                                        <tr>
                                            ${headers.map(header => `<th>${header}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${item.answer.map(row =>
                                            `<tr>${Array.isArray(row) ? row.map(cell => `<td>${cell}</td>`).join('') : `<td colspan="${headers.length}">${row}</td>`}</tr>`
                                        ).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-grading" id="table-grading-${index}" style="display: none;">
                                <h4>Self-Grading:</h4>
                                <div class="points-input-container">
                                    <input type="number" class="points-input" name="table-points-${index}" min="0" max="${item.points}" value="0">
                                    <span class="points-label">/ ${item.points} points</span>
                                </div>
                                <textarea class="table-notes" name="table-notes-${index}" placeholder="Notes for yourself (optional)..."></textarea>
                            </div>
                        `;

                        tableCard.innerHTML = tableHTML;
                        essayContainer.appendChild(tableCard);
                        questionCounter++;
                    });
                }

                // Render essay questions after table questions
                if (quizData.essay && quizData.essay.length > 0) {
                    quizData.essay.forEach((item, index) => {
                        const essayCard = document.createElement('div');
                        essayCard.className = 'essay-card';

                        const imageHTML = item.image ? `<div class="essay-image"><img src="images/${item.image}" alt="Question ${questionCounter} diagram" /></div>` : '';

                        essayCard.innerHTML = `
                            <div class="question-number">Question ${questionCounter} (${item.points} points)</div>
                            ${imageHTML}
                            <div class="essay-question">${item.question}</div>
                            <textarea class="essay-textarea" name="essay${index}" placeholder="Write your answer here..." autocomplete="off" data-1p-ignore autocorrect="off" spellcheck="true"></textarea>
                            <div class="essay-answer" id="essay-answer-${index}" style="display: none;">
                                <h4>Sample Answer:</h4>
                                <div class="essay-answer-text">${item.answer}</div>
                            </div>
                            <div class="essay-grading" id="essay-grading-${index}" style="display: none;">
                                <h4>Self-Grading:</h4>
                                <div class="points-input-container">
                                    <input type="number" class="points-input" name="essay-points-${index}" min="0" max="${item.points}" value="0">
                                    <span class="points-label">/ ${item.points} points</span>
                                </div>
                                <textarea class="essay-notes" name="essay-notes-${index}" placeholder="Notes for yourself (optional)..."></textarea>
                            </div>
                        `;

                        essayContainer.appendChild(essayCard);
                        questionCounter++;
                    });
                }
            }

            // Add click handlers to option labels for better UX
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    const name = radio.name;

                    // Remove selected class from all options with same name
                    document.querySelectorAll(`input[name="${name}"]`).forEach(input => {
                        input.closest('.option').classList.remove('selected');
                    });

                    // Add selected class to this option
                    this.classList.add('selected');
                });
            });
        }

        function handleTableNavigation(event, tableIndex, currentRow, currentCol, totalRows, totalCols) {
            if (event.key === 'Enter') {
                event.preventDefault();

                let nextRow = currentRow;
                let nextCol = currentCol + 1;

                // If we're at the end of a row, move to next row, first column
                if (nextCol >= totalCols) {
                    nextRow = currentRow + 1;
                    nextCol = 0;
                }

                // If we're at the end of the table, move to next question
                if (nextRow >= totalRows) {
                    // Try to find the next focusable element (next question)
                    const currentTableCard = event.target.closest('.table-card');
                    const allCards = document.querySelectorAll('.essay-card, .table-card');

                    let foundCurrent = false;
                    for (let card of allCards) {
                        if (foundCurrent) {
                            // Focus the first input/textarea in the next card
                            const nextInput = card.querySelector('input, textarea');
                            if (nextInput) {
                                nextInput.focus();
                                return;
                            }
                        }
                        if (card === currentTableCard) {
                            foundCurrent = true;
                        }
                    }

                    // If no next question found, do nothing (stay in current cell)
                    return;
                }

                // Move to the next cell in the table
                const nextInput = document.querySelector(`input[name="table${tableIndex}-${nextRow}-${nextCol}"]`);
                if (nextInput) {
                    nextInput.focus();
                }
            }
        }

        function renderScantron() {
            if (!selectedQuestions) return;

            const scantronGrid = document.getElementById('scantron-grid');
            const numQuestions = selectedQuestions.length;

            // Find the maximum number of options across all questions
            const maxOptions = Math.max(...selectedQuestions.map(q => q.options.length));

            // Determine number of columns (typically 2 columns for scantron)
            const columns = 2;
            const questionsPerColumn = Math.ceil(numQuestions / columns);

            let scantronHTML = '';

            for (let col = 0; col < columns; col++) {
                scantronHTML += '<div class="scantron-column">';

                const startIdx = col * questionsPerColumn;
                const endIdx = Math.min(startIdx + questionsPerColumn, numQuestions);

                for (let i = startIdx; i < endIdx; i++) {
                    const questionNum = i + 1;

                    scantronHTML += `
                        <div class="scantron-row">
                            <span class="scantron-number">${questionNum}.</span>
                            <div class="scantron-bubbles">
                    `;

                    // Create bubbles for all options (A through max option letter)
                    for (let opt = 0; opt < maxOptions; opt++) {
                        const letter = String.fromCharCode(65 + opt); // A=65, B=66, etc.
                        scantronHTML += `
                            <div class="bubble-container">
                                <span class="bubble-letter">${letter}</span>
                                <div class="bubble"></div>
                            </div>
                        `;
                    }

                    scantronHTML += `
                            </div>
                        </div>
                    `;
                }

                scantronHTML += '</div>';
            }

            scantronGrid.innerHTML = scantronHTML;
        }

        function renderAnswerKey() {
            if (!quizData || !selectedQuestions) return;

            const answerKeyContent = document.getElementById('answer-key-content');
            let keyHTML = '';

            // Multiple Choice answers
            if (selectedQuestions && selectedQuestions.length > 0) {
                keyHTML += '<div class="answer-key-section"><h2>Multiple Choice</h2>';
                selectedQuestions.forEach((question, index) => {
                    const correctLetter = String.fromCharCode(65 + question.correct); // A=0, B=1, etc.
                    keyHTML += `<div class="answer-key-item">${index + 1}. ${correctLetter}</div>`;
                });
                keyHTML += '</div>';
            }

            // True/Make True answers
            if (quizData.trueMakeTrue && quizData.trueMakeTrue.length > 0) {
                keyHTML += '<div class="answer-key-section"><h2>True/Make True</h2>';
                quizData.trueMakeTrue.forEach((item, index) => {
                    let answer;
                    if (item.isTrue) {
                        answer = 'True';
                    } else {
                        const correctWords = Array.isArray(item.correctWord) ? item.correctWord : [item.correctWord];
                        answer = correctWords[0]; // Show first correct answer
                    }
                    keyHTML += `<div class="answer-key-item">${index + 1}. ${answer}</div>`;
                });
                keyHTML += '</div>';
            }

            // Table answers
            if (quizData.table && quizData.table.length > 0) {
                keyHTML += '<div class="answer-key-section"><h2>Table Questions</h2>';
                quizData.table.forEach((item, index) => {
                    keyHTML += `<div class="answer-key-item"><strong>Question ${index + 1}:</strong> ${item.question}</div>`;
                    if (item.answer && Array.isArray(item.answer)) {
                        keyHTML += '<div class="answer-key-table">';
                        item.answer.forEach((row, rowIdx) => {
                            if (Array.isArray(row)) {
                                keyHTML += `<div class="answer-key-row">${row.join(' | ')}</div>`;
                            } else {
                                keyHTML += `<div class="answer-key-row">${row}</div>`;
                            }
                        });
                        keyHTML += '</div>';
                    }
                });
                keyHTML += '</div>';
            }

            // Essay answers
            if (quizData.essay && quizData.essay.length > 0) {
                const questionOffset = (quizData.table ? quizData.table.length : 0);
                keyHTML += '<div class="answer-key-section"><h2>Essay/Short Answer</h2>';
                quizData.essay.forEach((item, index) => {
                    keyHTML += `<div class="answer-key-item">
                        <strong>Question ${index + 1 + questionOffset}:</strong> ${item.question}
                    </div>`;
                    keyHTML += `<div class="answer-key-essay">${item.answer}</div>`;
                });
                keyHTML += '</div>';
            }

            answerKeyContent.innerHTML = keyHTML;
        }

        function updateProgress() {
            const mcCount = selectedQuestions ? selectedQuestions.length : 0;
            const tmtCount = quizData.trueMakeTrue ? quizData.trueMakeTrue.length : 0;
            const tableCount = quizData.table ? quizData.table.length : 0;
            const essayCount = quizData.essay ? quizData.essay.length : 0;

            // Calculate total points
            const mcPoints = mcCount; // 1 point each
            const tmtPoints = quizData.trueMakeTrue ? quizData.trueMakeTrue.reduce((sum, item) => sum + (item.points || 1), 0) : 0;
            const tablePoints = quizData.table ? quizData.table.reduce((sum, item) => sum + (item.points || 1), 0) : 0;
            const essayPoints = quizData.essay ? quizData.essay.reduce((sum, item) => sum + (item.points || 1), 0) : 0;
            const totalPoints = mcPoints + tmtPoints + tablePoints + essayPoints;

            let sections = [];

            if (mcCount > 0) {
                sections.push(`${mcCount} Multiple Choice (${mcPoints} pts)`);
            }
            if (tmtCount > 0) {
                sections.push(`${tmtCount} True/Make True (${tmtPoints} pts)`);
            }
            if (tableCount > 0 || essayCount > 0) {
                const combinedCount = tableCount + essayCount;
                const combinedPoints = tablePoints + essayPoints;
                sections.push(`${combinedCount} Short/Long Answer (${combinedPoints} pts)`);
            }

            const progressText = `${totalPoints} Points<br>${sections.join('<br>')}`;
            document.getElementById('progress').innerHTML = progressText;
        }

        function checkAnswers() {
            if (!quizData || !selectedQuestions) return;

            // Check for blank answers before proceeding
            const questions = selectedQuestions;
            let blankMC = 0;
            let blankTMT = 0;
            let blankTable = 0;
            let blankEssay = 0;

            // Count blank multiple choice
            questions.forEach((question, index) => {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                if (!selected) blankMC++;
            });

            // Count blank true/make true
            if (quizData.trueMakeTrue) {
                quizData.trueMakeTrue.forEach((item, index) => {
                    const input = document.querySelector(`input[name="tmt${index}"]`);
                    if (!input || !input.value.trim()) blankTMT++;
                });
            }

            // Count blank table questions
            if (quizData.table) {
                quizData.table.forEach((item, index) => {
                    const headers = item.headers || ['Column 1', 'Column 2'];
                    const numRows = item.answer ? item.answer.length : 3;
                    let hasAnyInput = false;

                    for (let row = 0; row < numRows; row++) {
                        for (let col = 0; col < headers.length; col++) {
                            const input = document.querySelector(`input[name="table${index}-${row}-${col}"]`);
                            if (input && input.value.trim()) {
                                hasAnyInput = true;
                                break;
                            }
                        }
                        if (hasAnyInput) break;
                    }

                    if (!hasAnyInput) blankTable++;
                });
            }

            // Count blank essays
            if (quizData.essay) {
                quizData.essay.forEach((item, index) => {
                    const textarea = document.querySelector(`textarea[name="essay${index}"]`);
                    if (!textarea || !textarea.value.trim()) blankEssay++;
                });
            }

            // Show warning if there are blank answers
            if (blankMC > 0 || blankTMT > 0 || blankTable > 0 || blankEssay > 0) {
                let warningMessage = "You have unanswered questions:\n\n";
                if (blankMC > 0) warningMessage += `• ${blankMC} Multiple Choice question${blankMC > 1 ? 's' : ''}\n`;
                if (blankTMT > 0) warningMessage += `• ${blankTMT} True/Make True question${blankTMT > 1 ? 's' : ''}\n`;
                if (blankTable > 0) warningMessage += `• ${blankTable} Table question${blankTable > 1 ? 's' : ''}\n`;
                if (blankEssay > 0) warningMessage += `• ${blankEssay} Essay question${blankEssay > 1 ? 's' : ''}\n`;
                warningMessage += "\nDo you want to submit anyway?";

                if (!confirm(warningMessage)) {
                    return; // Cancel submission
                }
            }

            let mcScore = 0;
            let tmtScore = 0;

            // Check multiple choice questions
            questions.forEach((question, index) => {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                const allOptions = document.querySelectorAll(`input[name="q${index}"]`);
                const correctAnswer = question.correct;

                if (selected) {
                    const answer = parseInt(selected.value);

                    // Style all options based on correctness
                    allOptions.forEach((option, optionIndex) => {
                        const optionElement = option.closest('.option');
                        optionElement.classList.remove('selected');

                        if (optionIndex === correctAnswer) {
                            optionElement.classList.add('correct');
                        } else if (option.checked && optionIndex !== correctAnswer) {
                            optionElement.classList.add('incorrect');
                        }
                    });

                    if (answer === correctAnswer) {
                        mcScore++;
                    }
                } else {
                    // Highlight correct answer even if not selected
                    allOptions[correctAnswer].closest('.option').classList.add('correct');
                }
            });

            // Check True/Make True questions
            if (quizData.trueMakeTrue && quizData.trueMakeTrue.length > 0) {
                quizData.trueMakeTrue.forEach((item, index) => {
                    const input = document.querySelector(`input[name="tmt${index}"]`);
                    const feedbackElement = document.getElementById(`tmt-feedback-${index}`);

                    if (input && feedbackElement) {
                        const userAnswer = input.value.trim().toLowerCase();
                        let isCorrect = false;

                        if (item.isTrue) {
                            // Statement is true, accept "true" or "t"
                            isCorrect = userAnswer === 'true' || userAnswer === 't';
                        } else {
                            // Statement is false, check if they provided the correct word
                            const correctWords = Array.isArray(item.correctWord) ? item.correctWord : [item.correctWord];
                            isCorrect = correctWords.some(word => userAnswer === word.toLowerCase());
                        }

                        if (isCorrect) {
                            tmtScore += (item.points || 1);
                            input.classList.add('correct');
                            feedbackElement.textContent = 'Correct!';
                            feedbackElement.className = 'feedback-text correct';
                        } else {
                            input.classList.add('incorrect');
                            if (item.isTrue) {
                                feedbackElement.innerHTML = '<span style="color: #ef4444;">Incorrect.</span> <span style="color: #10b981;">True</span>';
                            } else {
                                const correctWords = Array.isArray(item.correctWord) ? item.correctWord : [item.correctWord];
                                feedbackElement.innerHTML = `<span style="color: #ef4444;">Incorrect.</span> <span style="color: #10b981;">${correctWords.join(' or ')}</span>`;
                            }
                            feedbackElement.className = 'feedback-text';
                        }

                        feedbackElement.style.display = 'block';
                    }
                });
            }

            // Show table answers and grading interface
            if (quizData.table && quizData.table.length > 0) {
                quizData.table.forEach((item, index) => {
                    const answerElement = document.getElementById(`table-answer-${index}`);
                    const gradingElement = document.getElementById(`table-grading-${index}`);

                    // Make table inputs read-only
                    const tableInputs = document.querySelectorAll(`input[name^="table${index}-"]`);
                    tableInputs.forEach(input => {
                        input.readOnly = true;
                    });

                    // Show correct answers and grading interface
                    if (answerElement) answerElement.style.display = 'block';
                    if (gradingElement) gradingElement.style.display = 'block';
                });
            }

            // Show essay sample answers and grading interface
            if (quizData.essay && quizData.essay.length > 0) {
                quizData.essay.forEach((item, index) => {
                    const textarea = document.querySelector(`textarea[name="essay${index}"]`);
                    const answerElement = document.getElementById(`essay-answer-${index}`);
                    const gradingElement = document.getElementById(`essay-grading-${index}`);

                    // Make textarea read-only and expand to show full content
                    if (textarea) {
                        textarea.readOnly = true;
                        textarea.style.minHeight = 'auto';
                        textarea.style.height = Math.max(textarea.scrollHeight, 120) + 'px';
                        textarea.style.backgroundColor = '#f8fafc';
                        textarea.style.cursor = 'default';
                    }

                    if (answerElement) {
                        answerElement.style.display = 'block';
                    }
                    if (gradingElement) {
                        gradingElement.style.display = 'block';
                    }
                });
            }

            // Calculate total score (only MC and TMT are graded)
            const tmtMaxPoints = quizData.trueMakeTrue ? quizData.trueMakeTrue.reduce((sum, item) => sum + (item.points || 1), 0) : 0;
            const gradedPoints = questions.length + tmtMaxPoints;
            const totalScore = mcScore + tmtScore;
            const percentage = Math.round((totalScore / gradedPoints) * 100);

            let scoreDisplay;
            if (quizData.essay && quizData.essay.length > 0) {
                scoreDisplay = `ACTION REQUIRED<br>Review and self-evaluate your essay responses before calculating your score.`;
                document.getElementById('calculate-final-score').style.display = 'block';
            } else {
                scoreDisplay = `Score: ${totalScore}/${gradedPoints} (${percentage}%)`;
                if (quizData.trueMakeTrue && quizData.trueMakeTrue.length > 0) {
                    scoreDisplay += `<br><small>Multiple Choice: ${mcScore}/${questions.length}<br>True/Make True: ${tmtScore}/${tmtMaxPoints}</small>`;
                }
            }

            // Clear any selected highlighting
            document.querySelectorAll('.selected').forEach(element => {
                element.classList.remove('selected');
            });

            document.getElementById('score').innerHTML = scoreDisplay;
            document.getElementById('results').style.display = 'block';
            document.querySelector('.submit-button').disabled = true;
            document.querySelector('.submit-button').textContent = 'Quiz Completed';

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function calculateFinalScore() {
            if (!quizData || !quizData.essay) return;

            let essayScore = 0;
            let essayMaxPoints = 0;
            let incompleteGrading = false;

            quizData.essay.forEach((item, index) => {
                essayMaxPoints += item.points;
                const pointsInput = document.querySelector(`input[name="essay-points-${index}"]`);

                if (pointsInput && pointsInput.value !== '') {
                    const points = parseInt(pointsInput.value) || 0;
                    essayScore += Math.min(Math.max(points, 0), item.points); // Clamp between 0 and max points
                } else {
                    incompleteGrading = true;
                }
            });

            if (incompleteGrading) {
                alert('Please enter points for all essay questions before calculating final score.');
                return;
            }

            // Get existing MC and TMT scores
            const questions = selectedQuestions || [];
            const tmtQuestions = quizData.trueMakeTrue || [];

            let mcScore = 0, tmtScore = 0;

            // Recalculate MC score
            questions.forEach((question, index) => {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                if (selected && parseInt(selected.value) === question.correct) {
                    mcScore++;
                }
            });

            // Recalculate TMT score
            tmtQuestions.forEach((item, index) => {
                const input = document.querySelector(`input[name="tmt${index}"]`);
                if (input) {
                    const userAnswer = input.value.trim().toLowerCase();
                    let isCorrect = false;

                    if (item.isTrue) {
                        isCorrect = userAnswer === 'true' || userAnswer === 't';
                    } else {
                        const correctWords = Array.isArray(item.correctWord) ? item.correctWord : [item.correctWord];
                        isCorrect = correctWords.some(word => userAnswer === word.toLowerCase());
                    }

                    if (isCorrect) tmtScore += (item.points || 1);
                }
            });

            // Calculate final totals
            const tmtMaxPoints = tmtQuestions.reduce((sum, item) => sum + (item.points || 1), 0);
            const totalScore = mcScore + tmtScore + essayScore;
            const maxScore = questions.length + tmtMaxPoints + essayMaxPoints;
            const finalPercentage = Math.round((totalScore / maxScore) * 100);

            let finalScoreDisplay = `Final Score: ${totalScore}/${maxScore} (${finalPercentage}%)`;
            finalScoreDisplay += `<br><small>Multiple Choice: ${mcScore}/${questions.length} | True/Make True: ${tmtScore}/${tmtMaxPoints} | Essays: ${essayScore}/${essayMaxPoints}</small>`;

            document.getElementById('final-score').innerHTML = finalScoreDisplay;
            document.getElementById('final-score').style.display = 'block';
            document.getElementById('calculate-final-score').textContent = 'Recalculate Final Score';
        }

        // Load quiz when page loads
        document.addEventListener('DOMContentLoaded', loadQuizData);
    </script>
</body>
</html>