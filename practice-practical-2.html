<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Practical #2</title>
    <link rel="stylesheet" href="css/practical.css">
</head>
<body>
    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
        <span class="toggle-icon">üåô</span>
    </button>
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="home-link">‚Üê Home</a>
            <h1>Practice Practical #2</h1>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            Loading practical questions...
        </div>

        <div id="practical-content" class="practical-content" style="display: none;">
            <!-- Current image display -->
            <div class="image-container">
                <div class="image-content">
                    <img id="current-image" src="" alt="Practical question" />
                    <div id="current-question-text" class="question-text"></div>
                    <div class="inline-answer">
                        <div class="answer-center">
                            <button id="inline-question-number" class="inline-number" onclick="scrollToAnswerSheet()">1</button>
                            <input type="text" id="inline-answer-input" class="inline-input" placeholder="Type your answer..." oninput="syncAnswer()" onkeydown="handleEnterKey(event)" autocorrect="off" autocapitalize="off" spellcheck="false" />
                        </div>
                    </div>
                    <div class="navigation-buttons">
                        <button id="prev-btn" class="nav-btn nav-prev" onclick="previousImage()">‚Äπ</button>
                        <button id="next-btn" class="nav-btn nav-next" onclick="nextImage()">Next ‚Ä∫</button>
                    </div>
                    <div class="image-counter">
                        Question <span id="current-question">1</span> of 42
                    </div>
                </div>
            </div>
        </div>

        <!-- Answer Sheet -->
        <div class="answer-sheet">
            <div class="answer-sheet-header">
                <h2>Answer Sheet</h2>
                <div class="header-controls">
                    <button class="submit-button" onclick="submitPractical()">Submit Practical</button>
                    <div id="final-score" class="final-score" style="display: none;"></div>
                </div>
            </div>
            <div class="answers-grid">
                <!-- Generated by JavaScript -->
            </div>
        </div>

    </div>

    <script>
        let practicalData = null;
        let currentImageIndex = 0;
        let preloadedImages = new Map(); // Cache for preloaded images

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array]; // Create a copy
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        async function loadPractical() {
            try {
                const response = await fetch('data/practice-practical-2.yml');
                const yamlText = await response.text();
                practicalData = jsyaml.load(yamlText);

                // Shuffle the questions
                if (practicalData && practicalData.questions) {
                    practicalData.questions = shuffleArray(practicalData.questions);
                }
            } catch (error) {
                console.log('Using fallback data');
                // Fallback data structure
                practicalData = {
                    title: "Practice Practical #2",
                    description: "Blood, Heart, & Circulatory System identification practical",
                    questions: [
                        { id: 1, image: "images/practical-2/01.jpg", answer: "Sample Answer 1" },
                        { id: 2, image: "images/practical-2/02.jpg", answer: "Sample Answer 2" }
                        // Add more as needed
                    ]
                };
            }

            renderPractical();
        }

        function renderPractical() {
            if (!practicalData) return;


            // Generate answer sheet
            const answersGrid = document.querySelector('.answers-grid');

            // Create two columns
            const leftColumn = document.createElement('div');
            const rightColumn = document.createElement('div');
            leftColumn.className = 'answer-column';
            rightColumn.className = 'answer-column';

            const totalQuestions = 40;
            const availableQuestions = practicalData.questions.length;
            console.log('Available questions:', availableQuestions, 'Total questions:', totalQuestions);

            for (let i = 1; i <= totalQuestions; i++) {
                const answerItem = document.createElement('div');
                const isDisabled = i > availableQuestions;

                answerItem.className = `answer-item ${isDisabled ? 'disabled' : ''}`;
                answerItem.innerHTML = `
                    <button class="answer-number ${isDisabled ? 'disabled' : ''}"
                            onclick="${isDisabled ? '' : `goToImage(${i - 1})`}"
                            tabindex="-1">${i}</button>
                    <input type="text" name="answer${i}"
                           ${isDisabled ? 'disabled' : 'readonly'}
                           onclick="${isDisabled ? '' : `goToQuestionAndFocus(${i - 1})`}"
                           tabindex="${isDisabled ? '-1' : i}" />
                `;

                // Distribute vertically: 1-20 in left column, 21-40 in right column
                if (i <= 20) {
                    leftColumn.appendChild(answerItem);
                } else {
                    rightColumn.appendChild(answerItem);
                }
            }

            answersGrid.appendChild(leftColumn);
            answersGrid.appendChild(rightColumn);

            // Show first image
            showImage(0);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('practical-content').style.display = 'block';
        }

        function showImage(index) {
            if (!practicalData || !practicalData.questions) return;

            currentImageIndex = index;
            const question = practicalData.questions[index];

            // Clear the current image immediately to prevent old image showing
            const imageElement = document.getElementById('current-image');
            imageElement.src = '';

            if (question) {
                imageElement.src = `images/${question.image}`;
                document.getElementById('current-question').textContent = index + 1;
                document.getElementById('current-question-text').innerHTML = question.question || '';

                // Update inline answer elements
                document.getElementById('inline-question-number').textContent = index + 1;
                const currentAnswer = document.querySelector(`input[name="answer${index + 1}"]`);
                document.getElementById('inline-answer-input').value = currentAnswer ? currentAnswer.value : '';
            }

            // Update navigation buttons
            const maxIndex = practicalData ? practicalData.questions.length - 1 : 0;
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index >= maxIndex;

            // Update answer sheet number highlighting
            document.querySelectorAll('.answer-number').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            // Preload adjacent images
            preloadAdjacentImages(index);
        }

        function preloadImage(imagePath) {
            if (!imagePath || preloadedImages.has(imagePath)) {
                return; // Already preloaded or no path
            }

            const img = new Image();
            img.onload = () => {
                preloadedImages.set(imagePath, img);
            };
            img.src = `images/${imagePath}`;
        }

        function preloadAdjacentImages(currentIndex) {
            if (!practicalData || !practicalData.questions) return;

            // Preload previous image
            if (currentIndex > 0) {
                const prevQuestion = practicalData.questions[currentIndex - 1];
                if (prevQuestion && prevQuestion.image) {
                    preloadImage(prevQuestion.image);
                }
            }

            // Preload next image
            if (currentIndex < practicalData.questions.length - 1) {
                const nextQuestion = practicalData.questions[currentIndex + 1];
                if (nextQuestion && nextQuestion.image) {
                    preloadImage(nextQuestion.image);
                }
            }
        }

        function goToImage(index) {
            if (index >= 0 && index < 42) {
                showImage(index);
            }
        }

        function goToQuestionAndFocus(index) {
            if (index >= 0 && index < 42) {
                showImage(index);
                // Scroll to the image container
                document.querySelector('.image-container').scrollIntoView({ behavior: 'smooth' });
                // Focus the inline answer input after scrolling
                setTimeout(() => {
                    document.getElementById('inline-answer-input').focus();
                }, 300);
            }
        }

        function previousImage() {
            if (currentImageIndex > 0) {
                showImage(currentImageIndex - 1);
            }
        }

        function nextImage() {
            const maxIndex = practicalData ? practicalData.questions.length - 1 : 0;
            if (currentImageIndex < maxIndex) {
                showImage(currentImageIndex + 1);
            }
        }

        function submitPractical() {
            if (!practicalData || !practicalData.questions) return;

            // Collect answers
            const answers = {};
            let blankCount = 0;
            const blankQuestions = [];

            const availableQuestions = practicalData.questions.length;

            for (let i = 1; i <= availableQuestions; i++) {
                const input = document.querySelector(`input[name="answer${i}"]`);
                const answer = input ? input.value.trim() : '';
                answers[i] = answer;

                if (answer === '') {
                    blankCount++;
                    blankQuestions.push(i);
                }
            }

            // Warn about blank answers
            if (blankCount > 0) {
                const message = blankCount === 1
                    ? `You have 1 blank answer (Question ${blankQuestions[0]}). Are you sure you want to submit?`
                    : `You have ${blankCount} blank answers (Questions ${blankQuestions.slice(0, 5).join(', ')}${blankCount > 5 ? '...' : ''}). Are you sure you want to submit?`;

                if (!confirm(message)) {
                    return;
                }
            }

            // Score and update answer sheet
            let score = 0;
            let total = practicalData.questions.length;

            practicalData.questions.forEach((question, index) => {
                const questionNum = index + 1;
                const studentAnswer = answers[questionNum] || '';
                const correctAnswer = question.answer || '';
                const input = document.querySelector(`input[name="answer${questionNum}"]`);
                const circle = document.querySelectorAll('.answer-number')[index];

                // Calculate Levenshtein distance for similarity comparison
                const getLevenshteinDistance = (str1, str2) => {
                    const matrix = Array(str2.length + 1).fill(null).map(() => Array(str1.length + 1).fill(null));

                    for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
                    for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;

                    for (let j = 1; j <= str2.length; j++) {
                        for (let i = 1; i <= str1.length; i++) {
                            if (str1[i - 1] === str2[j - 1]) {
                                matrix[j][i] = matrix[j - 1][i - 1];
                            } else {
                                matrix[j][i] = Math.min(
                                    matrix[j - 1][i] + 1,     // deletion
                                    matrix[j][i - 1] + 1,     // insertion
                                    matrix[j - 1][i - 1] + 1  // substitution
                                );
                            }
                        }
                    }

                    return matrix[str2.length][str1.length];
                };

                // Calculate similarity score (0-1) based on edit distance
                const getSimilarityScore = (str1, str2) => {
                    const maxLength = Math.max(str1.length, str2.length);
                    if (maxLength === 0) return 1;
                    const distance = getLevenshteinDistance(str1, str2);
                    return 1 - (distance / maxLength);
                };

                // Normalize answers by removing leading articles and standardizing numerals
                const normalizeAnswer = (answer) => {
                    let normalized = answer.toLowerCase().trim();

                    // Remove leading articles
                    if (normalized.startsWith('the ')) {
                        normalized = normalized.substring(4);
                    } else if (normalized.startsWith('an ')) {
                        normalized = normalized.substring(3);
                    } else if (normalized.startsWith('a ')) {
                        normalized = normalized.substring(2);
                    }

                    // Convert Roman numerals to Arabic numerals
                    normalized = normalized.replace(/\bii\b/g, '2');
                    normalized = normalized.replace(/\bi\b/g, '1');

                    return normalized;
                };

                const normalizedStudentAnswer = normalizeAnswer(studentAnswer);

                // Determine scoring (exact match, partial credit, or incorrect)
                let answerResult = { isCorrect: false, isPartial: false, points: 0 };

                if (Array.isArray(correctAnswer)) {
                    // Handle multiple correct answers
                    for (const ans of correctAnswer) {
                        const normalizedCorrect = normalizeAnswer(ans);
                        if (normalizedStudentAnswer === normalizedCorrect) {
                            answerResult = { isCorrect: true, isPartial: false, points: 1 };
                            break;
                        } else {
                            const similarity = getSimilarityScore(normalizedStudentAnswer, normalizedCorrect);
                            // Consider it a close match if similarity is >= 0.75 (adjustable threshold)
                            if (similarity >= 0.75 && similarity < 1) {
                                answerResult = { isCorrect: false, isPartial: true, points: 0.5 };
                            }
                        }
                    }
                } else {
                    // Handle single correct answer
                    const normalizedCorrect = normalizeAnswer(correctAnswer);
                    if (normalizedStudentAnswer === normalizedCorrect) {
                        answerResult = { isCorrect: true, isPartial: false, points: 1 };
                    } else {
                        const similarity = getSimilarityScore(normalizedStudentAnswer, normalizedCorrect);
                        if (similarity >= 0.75 && similarity < 1) {
                            answerResult = { isCorrect: false, isPartial: true, points: 0.5 };
                        }
                    }
                }

                if (circle) {
                    score += answerResult.points; // Add points (0, 0.5, or 1)

                    if (answerResult.isCorrect) {
                        circle.classList.add('result-correct');
                        // Convert to display element
                        if (input) {
                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display correct';
                            displayDiv.innerHTML = `<span class="student-answer">${studentAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, null, question.image);
                            displayDiv.style.cursor = 'pointer';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    } else if (answerResult.isPartial) {
                        circle.classList.add('result-partial');
                        // Convert to display element with partial credit indicator
                        if (input) {
                            const displayAnswer = Array.isArray(correctAnswer)
                                ? correctAnswer.join(' OR ')
                                : correctAnswer;

                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display partial';
                            displayDiv.innerHTML = `<span class="student-answer">${studentAnswer}</span><span class="partial-indicator">(0.5)</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, displayAnswer, question.image);
                            displayDiv.style.cursor = 'pointer';
                            displayDiv.title = 'Click to see question and correction - Partial credit for close answer';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    } else if (studentAnswer) {
                        circle.classList.add('result-incorrect');
                        // Convert to display element with correction
                        if (input) {
                            const displayAnswer = Array.isArray(correctAnswer)
                                ? correctAnswer.join(' OR ')
                                : correctAnswer;

                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display incorrect';
                            displayDiv.innerHTML = `<span class="student-answer">${studentAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, displayAnswer, question.image);
                            displayDiv.style.cursor = 'pointer';
                            displayDiv.title = 'Click to see question and correction';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    } else {
                        circle.classList.add('result-unanswered');
                        // Show correct answer for unanswered
                        if (input) {
                            const displayAnswer = Array.isArray(correctAnswer)
                                ? correctAnswer.join(' OR ')
                                : correctAnswer;
                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display unanswered';
                            displayDiv.innerHTML = `<span class="correct-answer">${displayAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, null, question.image);
                            displayDiv.style.cursor = 'pointer';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    }
                }
            });

            const percentage = total > 0 ? Math.round((score / total) * 100) : 0;

            document.getElementById('final-score').innerHTML = `
                <strong>Final Score: ${score}/${total} (${percentage}%)</strong>
            `;
            document.getElementById('final-score').style.display = 'block';
            document.querySelector('.submit-button').style.display = 'none';
        }

        function syncAnswer() {
            const inlineInput = document.getElementById('inline-answer-input');
            const currentQuestionNum = currentImageIndex + 1;
            const answerSheetInput = document.querySelector(`input[name="answer${currentQuestionNum}"]`);

            if (answerSheetInput) {
                answerSheetInput.value = inlineInput.value;
            }
        }

        function scrollToAnswerSheet() {
            document.querySelector('.answer-sheet').scrollIntoView({ behavior: 'smooth' });
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                nextImage(); // Move to next question
            }
        }

        function showQuestionPopup(questionNum, questionText, correction, imagePath) {
            // Remove any existing popup
            const existingPopup = document.querySelector('.question-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            // Create popup
            const popup = document.createElement('div');
            popup.className = 'question-popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">
                        <h3>Question ${questionNum}</h3>
                        <button class="close-popup" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    ${imagePath ? `<div class="popup-image">
                        <img src="images/${imagePath}" alt="Question ${questionNum} image" />
                    </div>` : ''}
                    <div class="popup-question">${questionText || 'What is the tissue/structure?'}</div>
                    ${correction ? `<div class="popup-correction">
                        <strong>Correct answer:</strong> <span class="correction-text">${correction}</span>
                    </div>` : ''}
                </div>
            `;

            // Add to page
            document.body.appendChild(popup);

            // Add click outside to close
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        function toggleQuestionDetail(questionNum) {
            const existingDetail = document.getElementById(`detail-${questionNum}`);
            if (existingDetail) {
                existingDetail.remove();
                return;
            }

            // Remove any other open details
            document.querySelectorAll('[id^="detail-"]').forEach(el => el.remove());

            if (!practicalData || !practicalData.questions) return;

            const question = practicalData.questions[questionNum - 1];
            if (!question) return;

            const detailDiv = document.createElement('div');
            detailDiv.id = `detail-${questionNum}`;
            detailDiv.className = 'question-detail';
            detailDiv.innerHTML = `
                <div class="detail-content">
                    <div class="detail-image">
                        <img src="images/${question.image}" alt="Question ${questionNum}" />
                    </div>
                    <div class="detail-info">
                        <strong>Question ${questionNum}:</strong> ${question.question || 'What is the tissue/structure?'}
                    </div>
                </div>
            `;

            // Insert after the results circles
            const resultsCircles = document.querySelector('.results-circles');
            resultsCircles.insertAdjacentElement('afterend', detailDiv);
        }

        // Smart arrow key navigation
        document.addEventListener('keydown', function(event) {
            // Only handle arrow keys
            if (event.key !== 'ArrowLeft' && event.key !== 'ArrowRight') {
                return;
            }

            const inlineInput = document.getElementById('inline-answer-input');
            const isInputFocused = document.activeElement === inlineInput;

            let shouldNavigate = false;

            if (!isInputFocused) {
                // Input not focused - always allow navigation
                shouldNavigate = true;
            } else {
                // Input is focused - check cursor position
                const cursorPosition = inlineInput.selectionStart;
                const textLength = inlineInput.value.length;

                if (event.key === 'ArrowLeft' && cursorPosition === 0) {
                    // At beginning of text, allow left navigation
                    shouldNavigate = true;
                } else if (event.key === 'ArrowRight' && cursorPosition === textLength) {
                    // At end of text, allow right navigation
                    shouldNavigate = true;
                }
            }

            if (shouldNavigate) {
                event.preventDefault(); // Prevent default arrow behavior

                if (event.key === 'ArrowLeft') {
                    previousImage();
                } else if (event.key === 'ArrowRight') {
                    nextImage();
                }

                // Focus the input after navigation if it was focused before
                if (isInputFocused) {
                    setTimeout(() => {
                        document.getElementById('inline-answer-input').focus();
                    }, 0);
                }
            }
        });

        // Dark mode functionality
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const toggleIcon = document.querySelector('.toggle-icon');
        const body = document.body;

        // Function to get preferred theme
        function getPreferredTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                return savedTheme;
            }
            // Check system preference
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        // Function to apply theme
        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                toggleIcon.textContent = '‚òÄÔ∏è';
            } else {
                body.classList.remove('dark-mode');
                toggleIcon.textContent = 'üåô';
            }
        }

        // Apply initial theme
        const currentTheme = getPreferredTheme();
        applyTheme(currentTheme);

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only auto-switch if user hasn't set a preference
            if (!localStorage.getItem('theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });

        // Toggle dark mode
        darkModeToggle.addEventListener('click', () => {
            const newTheme = body.classList.contains('dark-mode') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Load YAML parser
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js';
        script.onload = loadPractical;
        document.head.appendChild(script);
    </script>
</body>
</html>