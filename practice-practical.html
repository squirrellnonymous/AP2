<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Practical - BIOL 224</title>
    <link rel="stylesheet" href="css/practical.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Practice Practical #1</h1>
            <div class="progress" id="progress">42 Questions</div>
        </div>
    </div>
    
    <div class="container">
        <div id="loading" class="loading">
            Loading practical questions...
        </div>
        
        <div id="practical-content" class="practical-content" style="display: none;">
            <!-- Current image display -->
            <div class="image-container">
                <div class="image-content">
                    <img id="current-image" src="" alt="Practical question" />
                    <div id="current-question-text" class="question-text"></div>
                    <div class="inline-answer">
                        <div class="answer-center">
                            <button id="inline-question-number" class="inline-number" onclick="scrollToAnswerSheet()">1</button>
                            <input type="text" id="inline-answer-input" class="inline-input" placeholder="Type your answer..." oninput="syncAnswer()" onkeydown="handleEnterKey(event)" autocorrect="off" autocapitalize="off" spellcheck="false" />
                        </div>
                    </div>
                    <div class="navigation-buttons">
                        <button id="prev-btn" class="nav-btn nav-prev" onclick="previousImage()">‹</button>
                        <button id="next-btn" class="nav-btn nav-next" onclick="nextImage()">Next ›</button>
                    </div>
                    <div class="image-counter">
                        Question <span id="current-question">1</span> of 42
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Answer Sheet -->
        <div class="answer-sheet">
            <div class="answer-sheet-header">
                <h2>Answer Sheet</h2>
                <div class="header-controls">
                    <button class="submit-button" onclick="submitPractical()">Submit Practical</button>
                    <div id="final-score" class="final-score" style="display: none;"></div>
                </div>
            </div>
            <div class="answers-grid">
                <!-- Generated by JavaScript -->
            </div>
        </div>
        
    </div>
    
    <script>
        let practicalData = null;
        let currentImageIndex = 0;
        
        async function loadPractical() {
            try {
                const response = await fetch('data/practice-practical.yml');
                const yamlText = await response.text();
                practicalData = jsyaml.load(yamlText);
            } catch (error) {
                console.log('Using fallback data');
                // Fallback data structure
                practicalData = {
                    title: "Practice Practical #1",
                    description: "Anatomy identification practical",
                    questions: [
                        { id: 1, image: "images/practical/01.jpg", answer: "Sample Answer 1" },
                        { id: 2, image: "images/practical/02.jpg", answer: "Sample Answer 2" }
                        // Add more as needed
                    ]
                };
            }
            
            renderPractical();
        }
        
        function renderPractical() {
            if (!practicalData) return;
            
            
            // Generate answer sheet
            const answersGrid = document.querySelector('.answers-grid');
            
            // Create two columns
            const leftColumn = document.createElement('div');
            const rightColumn = document.createElement('div');
            leftColumn.className = 'answer-column';
            rightColumn.className = 'answer-column';
            
            for (let i = 1; i <= 42; i++) {
                const answerItem = document.createElement('div');
                answerItem.className = 'answer-item';
                answerItem.innerHTML = `
                    <button class="answer-number" onclick="goToImage(${i - 1})" tabindex="-1">${i}</button>
                    <input type="text" name="answer${i}" readonly onclick="goToQuestionAndFocus(${i - 1})" tabindex="${i}" />
                `;
                
                // Distribute vertically: 1-21 in left column, 22-42 in right column
                if (i <= 21) {
                    leftColumn.appendChild(answerItem);
                } else {
                    rightColumn.appendChild(answerItem);
                }
            }
            
            answersGrid.appendChild(leftColumn);
            answersGrid.appendChild(rightColumn);
            
            // Show first image
            showImage(0);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('practical-content').style.display = 'block';
        }
        
        function showImage(index) {
            if (!practicalData || !practicalData.questions) return;
            
            currentImageIndex = index;
            const question = practicalData.questions[index];
            
            if (question) {
                document.getElementById('current-image').src = question.image;
                document.getElementById('current-question').textContent = index + 1;
                document.getElementById('current-question-text').innerHTML = question.question || '';
                
                // Update inline answer elements
                document.getElementById('inline-question-number').textContent = index + 1;
                const currentAnswer = document.querySelector(`input[name="answer${index + 1}"]`);
                document.getElementById('inline-answer-input').value = currentAnswer ? currentAnswer.value : '';
            }
            
            // Update navigation buttons
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index >= 41;
            
            // Update answer sheet number highlighting
            document.querySelectorAll('.answer-number').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }
        
        function goToImage(index) {
            if (index >= 0 && index < 42) {
                showImage(index);
            }
        }
        
        function goToQuestionAndFocus(index) {
            if (index >= 0 && index < 42) {
                showImage(index);
                // Scroll to the image container
                document.querySelector('.image-container').scrollIntoView({ behavior: 'smooth' });
                // Focus the inline answer input after scrolling
                setTimeout(() => {
                    document.getElementById('inline-answer-input').focus();
                }, 300);
            }
        }
        
        function previousImage() {
            if (currentImageIndex > 0) {
                showImage(currentImageIndex - 1);
            }
        }
        
        function nextImage() {
            if (currentImageIndex < 41) {
                showImage(currentImageIndex + 1);
            }
        }
        
        function submitPractical() {
            if (!practicalData || !practicalData.questions) return;
            
            // Collect answers
            const answers = {};
            let blankCount = 0;
            const blankQuestions = [];
            
            for (let i = 1; i <= 42; i++) {
                const input = document.querySelector(`input[name="answer${i}"]`);
                const answer = input ? input.value.trim() : '';
                answers[i] = answer;
                
                if (answer === '') {
                    blankCount++;
                    blankQuestions.push(i);
                }
            }
            
            // Warn about blank answers
            if (blankCount > 0) {
                const message = blankCount === 1 
                    ? `You have 1 blank answer (Question ${blankQuestions[0]}). Are you sure you want to submit?`
                    : `You have ${blankCount} blank answers (Questions ${blankQuestions.slice(0, 5).join(', ')}${blankCount > 5 ? '...' : ''}). Are you sure you want to submit?`;
                    
                if (!confirm(message)) {
                    return;
                }
            }
            
            // Score and update answer sheet
            let score = 0;
            let total = practicalData.questions.length;
            
            practicalData.questions.forEach((question, index) => {
                const questionNum = index + 1;
                const studentAnswer = answers[questionNum] || '';
                const correctAnswer = question.answer || '';
                const input = document.querySelector(`input[name="answer${questionNum}"]`);
                const circle = document.querySelectorAll('.answer-number')[index];
                
                // Normalize answers by removing leading "the "
                const normalizeAnswer = (answer) => {
                    const normalized = answer.toLowerCase().trim();
                    return normalized.startsWith('the ') ? normalized.substring(4) : normalized;
                };
                
                const normalizedStudentAnswer = normalizeAnswer(studentAnswer);
                
                // Handle multiple correct answers or single answer
                const isCorrect = Array.isArray(correctAnswer) 
                    ? correctAnswer.some(ans => {
                        const normalizedCorrect = normalizeAnswer(ans);
                        return normalizedStudentAnswer === normalizedCorrect;
                    })
                    : normalizedStudentAnswer === normalizeAnswer(correctAnswer);
                
                if (circle) {
                    if (isCorrect) {
                        circle.classList.add('result-correct');
                        score++;
                        // Convert to display element
                        if (input) {
                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display correct';
                            displayDiv.innerHTML = `<span class="student-answer">${studentAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, null, question.image);
                            displayDiv.style.cursor = 'pointer';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    } else if (studentAnswer) {
                        circle.classList.add('result-incorrect');
                        // Convert to display element with correction
                        if (input) {
                            const displayAnswer = Array.isArray(correctAnswer) 
                                ? correctAnswer.join(' OR ') 
                                : correctAnswer;
                            
                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display incorrect';
                            displayDiv.innerHTML = `<span class="student-answer">${studentAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, displayAnswer, question.image);
                            displayDiv.style.cursor = 'pointer';
                            displayDiv.title = 'Click to see question and correction';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    } else {
                        circle.classList.add('result-unanswered');
                        // Show correct answer for unanswered
                        if (input) {
                            const displayAnswer = Array.isArray(correctAnswer) 
                                ? correctAnswer.join(' OR ') 
                                : correctAnswer;
                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display unanswered';
                            displayDiv.innerHTML = `<span class="correct-answer">${displayAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, null, question.image);
                            displayDiv.style.cursor = 'pointer';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    }
                }
            });
            
            const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
            
            document.getElementById('final-score').innerHTML = `
                <strong>Final Score: ${score}/${total} (${percentage}%)</strong>
            `;
            document.getElementById('final-score').style.display = 'block';
            document.querySelector('.submit-button').style.display = 'none';
        }
        
        function syncAnswer() {
            const inlineInput = document.getElementById('inline-answer-input');
            const currentQuestionNum = currentImageIndex + 1;
            const answerSheetInput = document.querySelector(`input[name="answer${currentQuestionNum}"]`);
            
            if (answerSheetInput) {
                answerSheetInput.value = inlineInput.value;
            }
        }
        
        function scrollToAnswerSheet() {
            document.querySelector('.answer-sheet').scrollIntoView({ behavior: 'smooth' });
        }
        
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                nextImage(); // Move to next question
            }
        }
        
        function showQuestionPopup(questionNum, questionText, correction, imagePath) {
            // Remove any existing popup
            const existingPopup = document.querySelector('.question-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'question-popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">
                        <h3>Question ${questionNum}</h3>
                        <button class="close-popup" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
                    </div>
                    ${imagePath ? `<div class="popup-image">
                        <img src="${imagePath}" alt="Question ${questionNum} image" />
                    </div>` : ''}
                    <div class="popup-question">${questionText || 'What is the tissue/structure?'}</div>
                    ${correction ? `<div class="popup-correction">
                        <strong>Correct answer:</strong> <span class="correction-text">${correction}</span>
                    </div>` : ''}
                </div>
            `;
            
            // Add to page
            document.body.appendChild(popup);
            
            // Add click outside to close
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }
        
        function toggleQuestionDetail(questionNum) {
            const existingDetail = document.getElementById(`detail-${questionNum}`);
            if (existingDetail) {
                existingDetail.remove();
                return;
            }
            
            // Remove any other open details
            document.querySelectorAll('[id^="detail-"]').forEach(el => el.remove());
            
            if (!practicalData || !practicalData.questions) return;
            
            const question = practicalData.questions[questionNum - 1];
            if (!question) return;
            
            const detailDiv = document.createElement('div');
            detailDiv.id = `detail-${questionNum}`;
            detailDiv.className = 'question-detail';
            detailDiv.innerHTML = `
                <div class="detail-content">
                    <div class="detail-image">
                        <img src="${question.image}" alt="Question ${questionNum}" />
                    </div>
                    <div class="detail-info">
                        <strong>Question ${questionNum}:</strong> ${question.question || 'What is the tissue/structure?'}
                    </div>
                </div>
            `;
            
            // Insert after the results circles
            const resultsCircles = document.querySelector('.results-circles');
            resultsCircles.insertAdjacentElement('afterend', detailDiv);
        }
        
        // Load YAML parser
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js';
        script.onload = loadPractical;
        document.head.appendChild(script);
    </script>
</body>
</html>