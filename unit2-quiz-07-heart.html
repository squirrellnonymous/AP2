<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Quiz - Heart Anatomy & Cardiac Circulation</title>
    <meta property="og:image" content="images/practical-2/52.jpg">
    <meta property="og:title" content="Heart Quiz - BIOL 224">
    <meta property="og:description" content="Test your knowledge of heart anatomy with this interactive quiz">
    <link rel="stylesheet" href="css/practical.css">
</head>
<body>
    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
        <span class="toggle-icon">ðŸŒ™</span>
    </button>
    <div class="header">
        <div class="header-content">
            <h1>Heart Quiz</h1>
            <div class="progress" id="progress">4 Questions</div>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            Loading quiz questions...
        </div>

        <div id="practical-content" class="practical-content" style="display: none;">
            <!-- Current image display -->
            <div class="image-container">
                <div class="image-content">
                    <img id="current-image" src="" alt="Quiz question" />
                    <div id="current-question-text" class="question-text"></div>
                    <div class="inline-answer">
                        <div class="answer-center">
                            <button id="inline-question-number" class="inline-number" onclick="scrollToAnswerSheet()">1</button>
                            <input type="text" id="inline-answer-input" class="inline-input" placeholder="Type your answer..." oninput="syncAnswer()" onkeydown="handleEnterKey(event)" autocorrect="off" autocapitalize="off" spellcheck="false" />
                        </div>
                    </div>
                    <div class="navigation-buttons">
                        <button id="prev-btn" class="nav-btn nav-prev" onclick="previousImage()">â€¹</button>
                        <button id="next-btn" class="nav-btn nav-next" onclick="nextImage()">Next â€º</button>
                        <button id="inline-submit-btn" class="nav-btn nav-submit" onclick="submitQuiz()" style="display: none;">Submit</button>
                    </div>
                    <div class="image-counter">
                        Question <span id="current-question">1</span> of 4
                    </div>
                </div>
            </div>
        </div>

        <!-- Answer Sheet -->
        <div class="answer-sheet">
            <div class="answer-sheet-header">
                <h2>Answer Sheet</h2>
                <div class="header-controls">
                    <button class="submit-button" onclick="submitQuiz()">Submit Quiz</button>
                    <div id="final-score" class="final-score" style="display: none;"></div>
                </div>
            </div>
            <div class="answers-grid">
                <!-- Generated by JavaScript -->
            </div>
        </div>

    </div>

    <script>
        let quizData = null;
        let currentImageIndex = 0;
        let preloadedImages = new Map(); // Cache for preloaded images

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array]; // Create a copy
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        async function loadQuiz() {
            try {
                const response = await fetch('data/unit2-practical.yml');
                const yamlText = await response.text();
                const practicalData = jsyaml.load(yamlText);

                // Filter questions with "heart-lp-4" or "heart-lp-5" tags
                const heartQuestions = practicalData.questions.filter(question =>
                    question.tags && (question.tags.includes('heart-lp-4') || question.tags.includes('heart-lp-5')) &&
                    question.question && question.question.trim() !== '' &&
                    question.answer && (
                        Array.isArray(question.answer)
                            ? question.answer.some(ans => ans && ans.trim() !== '')
                            : question.answer.trim() !== ''
                    )
                );

                // Randomly select 4 questions
                const selectedQuestions = shuffleArray(heartQuestions).slice(0, 4);

                quizData = {
                    title: "Heart Quiz",
                    description: "4 random questions about the heart",
                    questions: selectedQuestions
                };

            } catch (error) {
                console.error('Error loading quiz data:', error);
                // Fallback data
                quizData = {
                    title: "Heart Quiz",
                    description: "Quiz about heart anatomy",
                    questions: []
                };
            }

            renderQuiz();
        }

        function renderQuiz() {
            if (!quizData || !quizData.questions.length) {
                document.getElementById('loading').textContent = 'No heart questions available.';
                return;
            }

            const totalQuestions = quizData.questions.length;
            console.log('Selected heart questions:', totalQuestions);

            // Update header with correct count
            const progressElement = document.getElementById('progress');
            if (progressElement) {
                progressElement.textContent = `${totalQuestions} Questions`;
            }

            // Generate answer sheet
            const answersGrid = document.querySelector('.answers-grid');
            answersGrid.innerHTML = ''; // Clear existing content

            // Create single column for 4 questions
            const column = document.createElement('div');
            column.className = 'answer-column';

            for (let i = 1; i <= totalQuestions; i++) {
                const answerItem = document.createElement('div');
                answerItem.className = 'answer-item';
                answerItem.innerHTML = `
                    <button class="answer-number" onclick="goToImage(${i - 1})" tabindex="-1">${i}</button>
                    <input type="text" name="answer${i}" readonly onclick="goToQuestionAndFocus(${i - 1})" tabindex="${i}" />
                `;
                column.appendChild(answerItem);
            }

            answersGrid.appendChild(column);

            // Show first image
            showImage(0);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('practical-content').style.display = 'block';
        }

        function showImage(index) {
            if (!quizData || !quizData.questions) return;

            currentImageIndex = index;
            const question = quizData.questions[index];

            // Clear the current image immediately to prevent old image showing
            const imageElement = document.getElementById('current-image');
            imageElement.src = '';

            if (question) {
                imageElement.src = `images/${question.image}`;
                document.getElementById('current-question').textContent = index + 1;
                document.getElementById('current-question-text').innerHTML = question.question || '';

                // Update inline answer elements
                document.getElementById('inline-question-number').textContent = index + 1;
                const currentAnswer = document.querySelector(`input[name="answer${index + 1}"]`);
                document.getElementById('inline-answer-input').value = currentAnswer ? currentAnswer.value : '';
            }

            // Update navigation buttons
            document.getElementById('prev-btn').disabled = index === 0;
            const isLastQuestion = index >= quizData.questions.length - 1;
            document.getElementById('next-btn').disabled = isLastQuestion;

            // Show/hide submit button based on whether we're at the last question
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('inline-submit-btn');
            if (isLastQuestion) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }

            // Update answer sheet number highlighting
            document.querySelectorAll('.answer-number').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            // Preload adjacent images
            preloadAdjacentImages(index);
        }

        function preloadImage(imagePath) {
            if (!imagePath || preloadedImages.has(imagePath)) {
                return; // Already preloaded or no path
            }

            const img = new Image();
            img.onload = () => {
                preloadedImages.set(imagePath, img);
            };
            img.src = `images/${imagePath}`;
        }

        function preloadAdjacentImages(currentIndex) {
            if (!quizData || !quizData.questions) return;

            // Preload previous image
            if (currentIndex > 0) {
                const prevQuestion = quizData.questions[currentIndex - 1];
                if (prevQuestion && prevQuestion.image) {
                    preloadImage(prevQuestion.image);
                }
            }

            // Preload next image
            if (currentIndex < quizData.questions.length - 1) {
                const nextQuestion = quizData.questions[currentIndex + 1];
                if (nextQuestion && nextQuestion.image) {
                    preloadImage(nextQuestion.image);
                }
            }
        }

        function goToImage(index) {
            if (index >= 0 && index < quizData.questions.length) {
                showImage(index);
            }
        }

        function goToQuestionAndFocus(index) {
            if (index >= 0 && index < quizData.questions.length) {
                showImage(index);
                // Scroll to the image container
                document.querySelector('.image-container').scrollIntoView({ behavior: 'smooth' });
                // Focus the inline answer input after scrolling
                setTimeout(() => {
                    document.getElementById('inline-answer-input').focus();
                }, 300);
            }
        }

        function previousImage() {
            if (currentImageIndex > 0) {
                showImage(currentImageIndex - 1);
            }
        }

        function nextImage() {
            if (currentImageIndex < quizData.questions.length - 1) {
                showImage(currentImageIndex + 1);
            }
        }

        function submitQuiz() {
            if (!quizData || !quizData.questions) return;

            // Collect answers
            const answers = {};
            let blankCount = 0;
            const blankQuestions = [];

            for (let i = 1; i <= quizData.questions.length; i++) {
                const input = document.querySelector(`input[name="answer${i}"]`);
                const answer = input ? input.value.trim() : '';
                answers[i] = answer;

                if (answer === '') {
                    blankCount++;
                    blankQuestions.push(i);
                }
            }

            // Warn about blank answers
            if (blankCount > 0) {
                const message = blankCount === 1
                    ? `You have 1 blank answer (Question ${blankQuestions[0]}). Are you sure you want to submit?`
                    : `You have ${blankCount} blank answers (Questions ${blankQuestions.join(', ')}). Are you sure you want to submit?`;

                if (!confirm(message)) {
                    return;
                }
            }

            // Score and update answer sheet
            let score = 0;
            let total = quizData.questions.length;

            quizData.questions.forEach((question, index) => {
                const questionNum = index + 1;
                const studentAnswer = answers[questionNum] || '';
                const correctAnswer = question.answer || '';
                const input = document.querySelector(`input[name="answer${questionNum}"]`);
                const circle = document.querySelectorAll('.answer-number')[index];

                // Normalize answers by removing leading articles and standardizing numerals
                const normalizeAnswer = (answer) => {
                    let normalized = answer.toLowerCase().trim();

                    // Remove leading articles
                    if (normalized.startsWith('the ')) {
                        normalized = normalized.substring(4);
                    } else if (normalized.startsWith('an ')) {
                        normalized = normalized.substring(3);
                    } else if (normalized.startsWith('a ')) {
                        normalized = normalized.substring(2);
                    }

                    return normalized;
                };

                const normalizedStudentAnswer = normalizeAnswer(studentAnswer);

                // Handle multiple correct answers or single answer
                const isCorrect = Array.isArray(correctAnswer)
                    ? correctAnswer.some(ans => {
                        const normalizedCorrect = normalizeAnswer(ans);
                        return normalizedStudentAnswer === normalizedCorrect;
                    })
                    : normalizedStudentAnswer === normalizeAnswer(correctAnswer);

                if (circle) {
                    // Remove active class from all circles first
                    circle.classList.remove('active');

                    if (isCorrect) {
                        circle.classList.add('result-correct');
                        score++;
                        // Convert to display element
                        if (input) {
                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display correct';
                            displayDiv.innerHTML = `<span class="student-answer">${studentAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, null, question.image);
                            displayDiv.style.cursor = 'pointer';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    } else if (studentAnswer) {
                        circle.classList.add('result-incorrect');
                        // Convert to display element with correction
                        if (input) {
                            const displayAnswer = Array.isArray(correctAnswer)
                                ? correctAnswer.join(' OR ')
                                : correctAnswer;

                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display incorrect';
                            displayDiv.innerHTML = `<span class="student-answer">${studentAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, displayAnswer, question.image);
                            displayDiv.style.cursor = 'pointer';
                            displayDiv.title = 'Click to see question and correction';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    } else {
                        circle.classList.add('result-unanswered');
                        // Show correct answer for unanswered
                        if (input) {
                            const displayAnswer = Array.isArray(correctAnswer)
                                ? correctAnswer.join(' OR ')
                                : correctAnswer;
                            const displayDiv = document.createElement('div');
                            displayDiv.className = 'answer-display unanswered';
                            displayDiv.innerHTML = `<span class="correct-answer">${displayAnswer}</span>`;
                            displayDiv.onclick = () => showQuestionPopup(questionNum, question.question, null, question.image);
                            displayDiv.style.cursor = 'pointer';
                            input.parentNode.replaceChild(displayDiv, input);
                        }
                    }
                }
            });

            const percentage = total > 0 ? Math.round((score / total) * 100) : 0;

            document.getElementById('final-score').innerHTML = `
                <strong>Final Score: ${score}/${total} (${percentage}%)</strong>
            `;
            document.getElementById('final-score').style.display = 'block';
            document.querySelector('.submit-button').style.display = 'none';
        }

        function syncAnswer() {
            const inlineInput = document.getElementById('inline-answer-input');
            const currentQuestionNum = currentImageIndex + 1;
            const answerSheetInput = document.querySelector(`input[name="answer${currentQuestionNum}"]`);

            if (answerSheetInput) {
                answerSheetInput.value = inlineInput.value;
            }
        }

        function scrollToAnswerSheet() {
            document.querySelector('.answer-sheet').scrollIntoView({ behavior: 'smooth' });
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                nextImage(); // Move to next question
            }
        }

        function showQuestionPopup(questionNum, questionText, correction, imagePath) {
            // Remove any existing popup
            const existingPopup = document.querySelector('.question-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            // Create popup
            const popup = document.createElement('div');
            popup.className = 'question-popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">
                        <h3>Question ${questionNum}</h3>
                        <button class="close-popup" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                    ${imagePath ? `<div class="popup-image">
                        <img src="images/${imagePath}" alt="Question ${questionNum} image" />
                    </div>` : ''}
                    <div class="popup-question">${questionText || 'What is the tissue/structure?'}</div>
                    ${correction ? `<div class="popup-correction">
                        <strong>Correct answer:</strong> <span class="correction-text">${correction}</span>
                    </div>` : ''}
                </div>
            `;

            // Add to page
            document.body.appendChild(popup);

            // Add click outside to close
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        // Smart arrow key navigation
        document.addEventListener('keydown', function(event) {
            // Only handle arrow keys
            if (event.key !== 'ArrowLeft' && event.key !== 'ArrowRight') {
                return;
            }

            const inlineInput = document.getElementById('inline-answer-input');
            const isInputFocused = document.activeElement === inlineInput;

            let shouldNavigate = false;

            if (!isInputFocused) {
                // Input not focused - always allow navigation
                shouldNavigate = true;
            } else {
                // Input is focused - check cursor position
                const cursorPosition = inlineInput.selectionStart;
                const textLength = inlineInput.value.length;

                if (event.key === 'ArrowLeft' && cursorPosition === 0) {
                    // At beginning of text, allow left navigation
                    shouldNavigate = true;
                } else if (event.key === 'ArrowRight' && cursorPosition === textLength) {
                    // At end of text, allow right navigation
                    shouldNavigate = true;
                }
            }

            if (shouldNavigate) {
                event.preventDefault(); // Prevent default arrow behavior

                if (event.key === 'ArrowLeft') {
                    previousImage();
                } else if (event.key === 'ArrowRight') {
                    nextImage();
                }

                // Focus the input after navigation if it was focused before
                if (isInputFocused) {
                    setTimeout(() => {
                        document.getElementById('inline-answer-input').focus();
                    }, 0);
                }
            }
        });

        // Dark mode functionality
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const toggleIcon = document.querySelector('.toggle-icon');
        const body = document.body;

        // Function to get preferred theme
        function getPreferredTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                return savedTheme;
            }
            // Check system preference
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        // Function to apply theme
        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                toggleIcon.textContent = 'â˜€ï¸';
            } else {
                body.classList.remove('dark-mode');
                toggleIcon.textContent = 'ðŸŒ™';
            }
        }

        // Apply initial theme
        const currentTheme = getPreferredTheme();
        applyTheme(currentTheme);

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only auto-switch if user hasn't set a preference
            if (!localStorage.getItem('theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });

        // Toggle dark mode
        darkModeToggle.addEventListener('click', () => {
            const newTheme = body.classList.contains('dark-mode') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Load YAML parser
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js';
        script.onload = loadQuiz;
        document.head.appendChild(script);
    </script>
</body>
</html>